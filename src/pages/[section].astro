---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const sections = await getCollection('sections');
  
  return sections.map((entry) => ({
    params: { section: entry.data.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// Render the markdown content
const { Content } = await render(entry);

// Normalize choice targets from filenames to section IDs
const normalizedChoices = entry.data.choices?.map((choice) => ({
  text: choice.text,
  target: choice.target.replace('.md', ''), // e.g., "section-2.md" -> "section-2"
})) || [];

// Calculate file paths for metadata
const relativePath = `src/content/sections/${entry.id}.md`;
---

<BaseLayout currentView="game" title={entry.data.title}>
  <div class="section-container">
    <div class="section-metadata">
      <div class="metadata-item">
        <span class="metadata-label">Section ID:</span>
        <code class="metadata-value">{entry.data.id}</code>
      </div>
      <div class="metadata-item">
        <span class="metadata-label">Source File:</span>
        <code class="metadata-value">{relativePath}</code>
      </div>
    </div>
    <div class="section-body">
      <Content />
    </div>
    <div class="choices-container">
      {normalizedChoices.length > 0 ? (
        <>
          <h2>Your Choices:</h2>
          {normalizedChoices.map((choice) => (
            <a href={`/${choice.target}`} class="choice-btn">
              {choice.text}
            </a>
          ))}
        </>
      ) : (
        <p><em>The End</em></p>
      )}
    </div>
  </div>
</BaseLayout>

